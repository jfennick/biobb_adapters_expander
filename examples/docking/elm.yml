steps:
- extract_molecules_sdf:
    in:
      input_path: ../data/NCIOpen.sdf
      output_sdf_path: '&ligands.sdf'
      first_molecule: "1"
      last_molecule: "2"
# NOTE: We need to extract the models first, before splitting them into separate files.
# If we try to do both simultaneously, obabel ignores -f and -l and outputs ALL models.
- split_sdf:
    in:
      input_path: '*ligands.sdf'
      output_sdf_path: '&ligand.sdf' # Array type
- setup_receptor.yml:
- dsb.yml:
# NOTE: Do not add scattering arguments here, add them to the wic: metadata annotations.
# (We want this information at the call site, not inserted within the subworkflow.)

wic:
  steps:
    (1, extract_molecules_sdf):
      wic:
        graphviz:
          label: Choose Ligands from\nCheminformatics Database
    (2, split_sdf):
      wic:
        graphviz:
          label: Split Ligands into\nSeparate Files
    (3, setup_receptor.yml):
      in:
        pdb_id: 1ntp
      wic:
        inlineable: False # Due to yml wic tag inlineing issue
    (4, dsb.yml):
      scatter: [sdf_path]
      in:
        # Note that since we want to scatter over the entire subworkflow, we do
        # not want to go any deeper into the syntax tree / call stack, i.e. we
        # do not want to pass '*ligand.sdf' all the way through to input_path.
        sdf_path: '*ligand.sdf'
      wic:
        # Scattering changes the input/output types and thus creates a barrier to inlineing.
        inlineable: False
        steps:
          (1, docking.yml):
            wic:
              inlineable: False #True
              steps:
                (1, flc.yml):
                  wic:
                    # Since the above name refers to an embedded subworkflow, is NOT inlineing-invariant.
                    # Thus, if we want the tests to pass, we also need to disable inlineing here.
                    inlineable: False #True


# Beware 0 vs 1 -based indexing! JavaScript (and thus CWL) uses 0-based indices.
# If you accidentally use 1-based indices, the last array access will be out of
# bounds and return null, which causes the following nasty error message:

# Cannot make job: Expression evaluation error:
# Expecting value: line 1 column 1 (char 0)
# script was:
# ...
#     "index": 2
# };
# var self = [
# ...
# ];
# var runtime = {
#     "tmpdir": null,
#     "outdir": null
# };
# (function(){return ((self[inputs.__index__]));})()
# stdout was: 'undefined'
# stderr was: ''