steps:
- download_pdbbind_refined:
    in:
      query: "Kd < 100" # should be in units of micro molar
      max_row: 2 #25 # Use 1 for CI
      convert_Kd_dG: 'True'
      output_txt_path: '&binding_data.txt'
      output_pdb_paths: '&pdbbind_pdbs'
      output_sdf_paths: '&pdbbind_sdfs'
      experimental_dGs: '&exp_dGs'

# assign partial charges (ligand)
- convert_mol2:
    in:
      input_path: '*pdbbind_sdfs'
    scatter: [input_path]
- convert_pdbqt:
    in:
      output_pdb_path: '&ligand_prod.pdbqt'
    scatter: [input_path]

# remove waters, then assigns partial charges to the protein
- pdb4amber_run:
    in:
      input_pdb_path: '*pdbbind_pdbs'
      output_pdb_path: '&pdbbind_pdb4amber.pdb'
      config:
        remove_waters: True
        remove_hydrogen: True
    scatter: [input_pdb_path]

- convert_mol2:
    in:
      input_path: '*pdbbind_pdb4amber.pdb'
    scatter: [input_path]

- convert_pdbqt:
    in:
      output_pdb_path: '&protein_prod.pdbqt'
      arg1: -xr # Receptor needs to be rigid
    scatter: [input_path]

# rescore protein ligand complexes
- autodock_vina_rescore:
    in:
      input_ligand_pdbqt_path: '*ligand_prod.pdbqt'
      input_receptor_pdbqt_path: '*protein_prod.pdbqt'
      score_only: True
      #local_only: True
      output_log_path: '&vina_rescore.log'
      docking_score: '&rescoring_scores' # NOTE: Not a filename, just an explicit edge
      output_ligand_pdbqt_path: '&ligand_rescore.pdbqt'
      #output_batch_pdbqt_path: 'pdb_rescore.pdbqt'
    scatter: [input_ligand_pdbqt_path, input_receptor_pdbqt_path]
    scatterMethod: dotproduct

- duplicate:
    in:
      input_pdbqt_singleton_path: '*protein_prod.pdbqt'
      input_pdbqt_array_path: '*ligand_rescore.pdbqt'
      output_pdbqt_path: '&receptor_dup_2D.pdbqt'
    scatter: [input_pdbqt_singleton_path, input_pdbqt_array_path]
    scatterMethod: dotproduct

- autodock_vina_filter:
    in:
      input_log_paths: '*vina_rescore.log'
      input_txt_path: '*binding_data.txt'
      docking_score_cutoff: -1.0
      max_num_poses_per_ligand: 2
      max_num_poses_total: 1 #25 # Use 1 for CI same as max_row
      rescore: 'True'
      input_ligand_pdbqt_path: '*ligand_rescore.pdbqt'
      output_ligand_pdbqt_path: '&lignad_filter.pdbqt'
      input_receptor_pdbqt_path: '*receptor_dup_2D.pdbqt'
      output_receptor_pdbqt_path: '&receptor_filter.pdbqt'
      docking_scores: '&docking_rescores' # NOTE: Not a filename, just an explicit edge
      experimental_dGs: '&dGs' # NOTE: Not a filename, just an explicit edge

- setup_pdb.yml:
    in:
      input_pdb_path: '*pdbbind_pdb4amber.pdb'
      pdb_path: '&pdb.pdbqt'
      box_path: '&box.pdb'
      box_buffer: 20 # Angstroms
      water_type: spce
      forcefield: amber99sb-ildn
    scatter: [input_pdb_path]

#

# - stability.yml:
#     scatter: [crd_path, top_zip_path]
#     scatterMethod: dotproduct
#     in:
#       nsteps: 10000
#       dt: 0.002
#       temperature: 298.0
#       pressure: 1.0
# - autodock_vina_rescore.yml:
#     scatter: [input_pdb_path]
# - scatter_plot:
#     in:
#       xs: '*dGs'
#       ys: '*docking_scores'
#       ys2: '*docking_rescores'

# # TODO: rescore again, use for ys2
# - scatter_plot:
#     in:
#       xs: '*dGs'
#       ys: '*docking_rescores'
#       ys2: '*docking_rescores'

# wic:
#   graphviz:
#     label: Virtual Screening Demo
#   steps:
#     (1, setup_pdb.yml):
#       wic:
#         inlineable: False
#         graphviz:
#           label: Setup PDB
#     (2, download_smiles_ligand_db.yml):
#       wic:
#         inlineable: False
#     (3, assign_partial_charges.yml):
#       wic:
#         inlineable: False
#     (4, autodock_vina_batch):
#       wic:
#         graphviz:
#           label: Docking
#     (5, split_pdbqt):
#       wic:
#         graphviz:
#           label: Extract Docking\nPoses
#     (6, autodock_vina_filter):
#       wic:
#         graphviz:
#           label: Apply Docking\nScore Cutoff
#     (7, gen_topol_params.yml):
#       wic:
#         inlineable: False
#     (8, stability.yml):
#       wic:
#         inlineable: False
#     (9, autodock_vina_rescore.yml):
#       wic:
#         inlineable: False
#     (10, scatter_plot):
#       wic:
#         graphviz:
#           label: Plot Experimental\nvs Predicted Binding